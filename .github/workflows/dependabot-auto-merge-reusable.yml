---
name: Reusable Dependabot Auto-Merge Workflow

on:
  workflow_call:
    inputs:
      # CI check configuration
      code_analysis_check_name:
        description: 'Name of the code analysis check to wait for'
        required: false
        type: string
        default: 'Code Quality & Security Analysis'
      container_test_check_name:
        description: 'Name of the container test check to wait for'
        required: false
        type: string
        default: 'Container Integration Test'
      kubernetes_test_check_name:
        description: 'Name of the Kubernetes test check to wait for (optional)'
        required: false
        type: string
        default: ''
      
      # Auto-merge configuration
      enable_auto_merge:
        description: 'Enable auto-merge for dependabot PRs'
        required: false
        type: boolean
        default: true
      merge_method:
        description: 'Merge method (merge, squash, rebase)'
        required: false
        type: string
        default: 'squash'
      delete_branch:
        description: 'Delete branch after merge'
        required: false
        type: boolean
        default: true
      
      # Update type filters
      allow_patch:
        description: 'Allow auto-merge for patch updates'
        required: false
        type: boolean
        default: true
      allow_minor:
        description: 'Allow auto-merge for minor updates'
        required: false
        type: boolean
        default: true
      allow_major:
        description: 'Allow auto-merge for major updates'
        required: false
        type: boolean
        default: false
      
      # Additional filters
      additional_keywords:
        description: 'Additional keywords to allow auto-merge (comma-separated)'
        required: false
        type: string
        default: 'deps,ci,docker'

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: read
  statuses: read

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: (github.actor == 'dependabot[bot]' && github.event_name == 'pull_request') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ github.token }}

      - name: Get PR details
        id: pr-details
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            # For manual triggers, find the latest Dependabot PR
            PR_DATA=$(gh pr list --author="dependabot[bot]" --state=open --json=number,title,headRefOid,author --limit=1)
            if [[ "$PR_DATA" != "[]" ]]; then
              echo "title=$(echo "$PR_DATA" | jq -r '.[0].title')" >> $GITHUB_OUTPUT
              echo "author=$(echo "$PR_DATA" | jq -r '.[0].author.login')" >> $GITHUB_OUTPUT
              echo "pr_number=$(echo "$PR_DATA" | jq -r '.[0].number')" >> $GITHUB_OUTPUT
              echo "head_sha=$(echo "$PR_DATA" | jq -r '.[0].headRefOid')" >> $GITHUB_OUTPUT
            else
              echo "No Dependabot PRs found"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Wait for code analysis checks
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-code-analysis
        with:
          token: ${{ github.token }}
          checkName: ${{ inputs.code_analysis_check_name }}
          ref: ${{ steps.pr-details.outputs.head_sha }}
          timeoutSeconds: 1800
          intervalSeconds: 30

      - name: Wait for container test
        if: ${{ inputs.container_test_check_name != '' }}
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-container-test
        with:
          token: ${{ github.token }}
          checkName: ${{ inputs.container_test_check_name }}
          ref: ${{ steps.pr-details.outputs.head_sha }}
          timeoutSeconds: 1800
          intervalSeconds: 30

      - name: Wait for Kubernetes test
        if: ${{ inputs.kubernetes_test_check_name != '' }}
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-kubernetes-test
        with:
          token: ${{ github.token }}
          checkName: ${{ inputs.kubernetes_test_check_name }}
          ref: ${{ steps.pr-details.outputs.head_sha }}
          timeoutSeconds: 1800
          intervalSeconds: 30

      - name: Check if auto-merge is allowed
        id: check-auto-merge
        run: |
          TITLE="${{ steps.pr-details.outputs.title }}"
          ALLOW_MERGE=false
          
          # Check for update types
          if [[ "${{ inputs.allow_patch }}" == "true" && ("$TITLE" == *"patch"* || "$TITLE" == *"Patch"*) ]]; then
            ALLOW_MERGE=true
            echo "✅ Patch update detected and allowed"
          fi
          
          if [[ "${{ inputs.allow_minor }}" == "true" && ("$TITLE" == *"minor"* || "$TITLE" == *"Minor"*) ]]; then
            ALLOW_MERGE=true
            echo "✅ Minor update detected and allowed"
          fi
          
          if [[ "${{ inputs.allow_major }}" == "true" && ("$TITLE" == *"major"* || "$TITLE" == *"Major"*) ]]; then
            ALLOW_MERGE=true
            echo "✅ Major update detected and allowed"
          fi
          
          # Check for additional keywords
          IFS=',' read -ra KEYWORDS <<< "${{ inputs.additional_keywords }}"
          for keyword in "${KEYWORDS[@]}"; do
            if [[ "$TITLE" == *"$keyword"* ]]; then
              ALLOW_MERGE=true
              echo "✅ Keyword '$keyword' detected and allowed"
            fi
          done
          
          echo "allow_merge=$ALLOW_MERGE" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        if: |
          inputs.enable_auto_merge && 
          steps.check-auto-merge.outputs.allow_merge == 'true' &&
          steps.wait-for-code-analysis.outputs.conclusion == 'success' &&
          (inputs.container_test_check_name == '' || steps.wait-for-container-test.outputs.conclusion == 'success') &&
          (inputs.kubernetes_test_check_name == '' || steps.wait-for-kubernetes-test.outputs.conclusion == 'success') &&
          (github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch')
        run: |
          MERGE_FLAG=""
          case "${{ inputs.merge_method }}" in
            "squash")
              MERGE_FLAG="--squash"
              ;;
            "rebase")
              MERGE_FLAG="--rebase"
              ;;
            "merge")
              MERGE_FLAG="--merge"
              ;;
          esac
          
          DELETE_FLAG=""
          if [[ "${{ inputs.delete_branch }}" == "true" ]]; then
            DELETE_FLAG="--delete-branch"
          fi
          
          gh pr merge --auto $MERGE_FLAG $DELETE_FLAG "${{ steps.pr-details.outputs.pr_number }}" || {
            echo "Failed to enable auto-merge, attempting direct merge since CI passed"
            gh pr merge $MERGE_FLAG $DELETE_FLAG "${{ steps.pr-details.outputs.pr_number }}"
          }
          echo "✅ Merged Dependabot PR: ${{ steps.pr-details.outputs.title }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Comment on major updates
        if: |
          (github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch') &&
          (contains(steps.pr-details.outputs.title, 'major') || contains(steps.pr-details.outputs.title, 'Major')) &&
          inputs.allow_major == false &&
          (
            steps.wait-for-code-analysis.outputs.conclusion != 'success' ||
            (inputs.container_test_check_name != '' && steps.wait-for-container-test.outputs.conclusion != 'success') ||
            (inputs.kubernetes_test_check_name != '' && steps.wait-for-kubernetes-test.outputs.conclusion != 'success')
          )
        run: |
          gh pr comment "${{ steps.pr-details.outputs.pr_number }}" --body "⚠️ This is a **major version update** that requires manual review. Please test thoroughly before merging."
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Comment on failed checks
        if: |
          (github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch') &&
          steps.check-auto-merge.outputs.allow_merge == 'true' &&
          (
            steps.wait-for-code-analysis.outputs.conclusion != 'success' ||
            (inputs.container_test_check_name != '' && steps.wait-for-container-test.outputs.conclusion != 'success') ||
            (inputs.kubernetes_test_check_name != '' && steps.wait-for-kubernetes-test.outputs.conclusion != 'success')
          )
        run: |
          gh pr comment "${{ steps.pr-details.outputs.pr_number }}" --body "❌ Auto-merge blocked due to failed CI checks. Please review and fix the issues."
        env:
          GITHUB_TOKEN: ${{ github.token }}